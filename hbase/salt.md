# HBase 加盐

这里所说的加盐并非密码学中的加盐，而是在 rowkey 的前面分配随机数，当给 rowkey 随机前缀后，它就能分布到不同的 region 中，这里的前缀应该和你想要数据分散的不同的 region 的数量有关。

为了让同学们更好的理解加盐（salting）这个 rowkey 设计方法。我们以电信公司为例。

当我们去电信公司打印电话详单也就是通话记录。对于通话记录来说，每个人每月可能都有很多通话记录，而使用电信的用户也是亿计。这种信息，我们就能存入 HBase 当中。

对于通话记录，我们有什么信息需要保存呢？首先，肯定应该有主叫和被叫，然后有主叫被叫之间的通话时长，以及通话时间。除此之外，还应该有主叫的位置信息，和被叫的位置信息。

由此，我们的通话记录表需要记录的信息就出来了：主叫、被叫、时长、时间、主叫位置、被叫位置。

我们该如何来设计一张 HBase 表呢？

首先，HBase 表是依靠 rowkey 来定位的，我们应该将尽可能多的将查询的信息编入 rowkey 当中。HBase 的元数据表 mate 表就给我们了一个很好的示例。它包括了 namespace，表名，startKey，时间戳，计算出来的码（用于分散数据）。

所以，当我们设计通话记录的 rowkey 时，需要将能唯一确定该条记录的数据编入 rowkey 当中。即是需要将主叫、被叫、时间编入。

如下所示：

```
17765657979 18688887777 201806121502 #主叫，被叫，时间
```

但是我们能否将我们设计的 rowkey 真正应用呢？

当然是可以的，但是热点问题便会随之而来。

例如你的电话是以 177 开头，电信的 HBase 集群有 500 台，你的数据就只可能被存入一台或者两台机器的 region 当中，当你需要打印自己的通话记录时，就只有一台机器为你服务。而若是你的数据均匀分散到 500 机器中，就是整个集群为你服务。两者之间效率速度差了不止一个数量级。

> 注意：由于我们的 regionServer 就只有一台，没有集群环境，所以我们只介绍方法和理论操作，不提供实际结果。

因为我们设定整个 HBase 集群有 500 台，所以我们随机在 0-499 之间中随机数字，添加到 rowkey 首部。

如下所示：

```
12 17765657979 18688887777 201806121502 #随机数，主叫，被叫，时间
```

在插入数据时，判断首部随机数字，选择对应的 region 存入，由于 rowkey 首部数字随机，所以数据也将随机分布到不同的 regionServer 中。这样就能很好的避免热点问题了。
